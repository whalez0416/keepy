<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keepy - ë³‘ì˜ì› í†µí•© ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2C64F8;
            --bg: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-main: #1E293B;
            --text-sub: #64748B;
            --success: #10B981;
            --danger: #EF4444;
            --accent: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Pretendard', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        aside {
            width: 260px;
            background: #0F172A;
            color: white;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            color: var(--primary);
        }

        nav ul {
            list-style: none;
        }

        nav li {
            padding: 1rem 0;
            color: #94A3B8;
            cursor: pointer;
            transition: 0.3s;
        }

        nav li.active {
            color: white;
            font-weight: 600;
        }

        nav li:hover {
            color: white;
        }

        .admin-only {
            display: none;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 2rem 3rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-sub);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Main Monitoring Card */
        .monitor-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid #E2E8F0;
        }

        .site-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--success);
            margin-bottom: 1rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        .control-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .control-item h3 {
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        select,
        input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #CBD5E1;
            margin-top: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1.5rem;
            width: 100%;
        }

        .price-tag {
            background: #F1F5F9;
            padding: 1.5rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .price-value {
            color: var(--primary);
            font-size: 1.25rem;
            font-weight: 700;
        }
    </style>
</head>

<body>
    <aside>
        <div class="logo">Keepy</div>
        <nav>
            <ul>
                <li onclick="switchTab('dashboard', this)" class="active">ëŒ€ì‹œë³´ë“œ</li>
                <li onclick="switchTab('logs', this)">ëª¨ë‹ˆí„°ë§ ë¡œê·¸</li>
                <li onclick="switchTab('spam-logs', this)">ğŸ”” ìŠ¤íŒ¸ ê°ì§€ ë‚´ì—­</li>
                <li onclick="switchTab('settings', this)">ëª¨ë‹ˆí„°ë§ ì„¤ì •</li>
                <li onclick="switchTab('billing', this)">ê²°ì œ ë‚´ì—­</li>
                <li onclick="switchTab('profile', this)">ë‚´ ì •ë³´ ìˆ˜ì •</li>
                <li onclick="switchTab('support', this)">ê³ ê°ì„¼í„°</li>
                <li onclick="switchTab('security-guide', this)">ë³´ì•ˆ ê¸°ëŠ¥ ì•ˆë‚´</li>
                <li id="adminMenuItem" class="admin-only" onclick="window.location.href='/admin'"
                    style="border-top: 1px solid #334155; margin-top: 1rem; padding-top: 1.5rem;">ğŸ›¡ï¸ ê´€ë¦¬ì í˜ì´ì§€</li>
            </ul>
        </nav>
    </aside>

    <main>
        <header>
            <h1 id="pageTitle">ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
            <div class="user-info">
                <div style="text-align: right; margin-right: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                        <span id="userNameLabel" style="font-weight: 600;">ë¯¼ë³‘ì› ì›ì¥ë‹˜</span>
                        <div id="userRoleBadge"
                            style="padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; background: #334155; color: white;">
                            User</div>
                    </div>
                    <div onclick="logout()"
                        style="font-size: 0.75rem; color: var(--text-sub); cursor: pointer; margin-top: 2px; text-decoration: underline;">
                        ë¡œê·¸ì•„ì›ƒ</div>
                </div>
                <div style="width: 40px; height: 40px; background: #E2E8F0; border-radius: 50%;"></div>
            </div>
        </header>

        <div id="section-dashboard" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ì˜¤ëŠ˜ ì‚­ì œëœ ìŠ¤íŒ¸</div>
                    <div class="stat-value" id="spamCount">24ê°œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ìë™ ë³µêµ¬ íšŸìˆ˜</div>
                    <div class="stat-value" id="recoveryCount">1íšŒ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì—…íƒ€ì„ (24h)</div>
                    <div class="stat-value" id="uptimeValue">99.9%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì´ë²ˆ ë‹¬ ì˜ˆìƒ ìš”ê¸ˆ</div>
                    <div class="stat-value" id="estPrice">19,800ì›</div>
                </div>
            </div>

            <!-- DB Connection / Registration Card (Shown if no sites, or manually toggleable) -->
            <div class="monitor-card" id="registerCard"
                style="display: none; margin-bottom: 2rem; border: 1px solid var(--primary);">
                <h2 style="margin-bottom: 1rem; color: var(--primary);">ğŸ¥ ë¯¼ë³‘ì› DB ì—°ê²° (ì´ˆê¸° ì„¤ì •)</h2>
                <div class="db-credentials"
                    style="background: #F1F5F9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>ìë™ ê°ì§€ëœ ì„¤ì •:</strong><br>
                    Host: localhost | User: minhospital2008 | DB: minhospital2008
                </div>
                <button class="btn-primary" onclick="registerMinHospital()">DB ì—°ê²° ë° ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
                <div id="registerResult" style="margin-top: 1rem;"></div>
            </div>

            <div class="monitor-card" id="statusCard">
                <div class="site-status">
                    <div class="status-dot"></div>
                    <span>ë¯¼ë³‘ì› í™ˆí˜ì´ì§€ ì •ìƒ ì‘ë™ ì¤‘</span>
                </div>
                <p style="color: var(--text-sub);" id="lastChecked">ìµœê·¼ ì ê²€: 32ì´ˆ ì „ (<a href="https://minhospital.co.kr"
                        target="_blank" style="color: var(--primary); text-decoration: none;">https://minhospital.co.kr
                        ğŸ”—</a>)</p>

                <div class="control-panel">
                    <div class="control-item">
                        <h3>ê°€ë³€ ëª¨ë‹ˆí„°ë§ ì£¼ê¸° ì„¤ì •</h3>
                        <select id="intervalSelect" onchange="updatePrice()">
                            <option value="1">1ë¶„ (ê°€ì¥ ì•ˆì „ / 29,800ì›)</option>
                            <option value="3" selected>3ë¶„ (ì¶”ì²œ / 19,800ì›)</option>
                            <option value="5">5ë¶„ (ë³´í†µ / 9,900ì›)</option>
                        </select>
                        <div class="price-tag">
                            <span>ì›” ì˜ˆìƒ ì²­êµ¬ ê¸ˆì•¡</span>
                            <span class="price-value" id="priceDisplay">19,800ì›</span>
                        </div>
                    </div>

                    <div class="control-item">
                        <h3>ì…€í”„ íë§ (ì„œë²„ ìê°€ ë³µêµ¬)</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                            <input type="checkbox" checked style="width: auto;">
                            ì¥ì•  ê°ì§€ ì‹œ ì„œë²„ ìë™ ì¬ì‹œì‘ í™œì„±í™”
                        </label>
                        <div style="display: flex; gap: 10px; width: 100%;">
                            <button class="btn-primary" onclick="saveMonitoringInterval()" style="flex: 1;">ì„¤ì •
                                ì €ì¥</button>
                            <button class="btn-primary" onclick="triggerManualScan()"
                                style="background: var(--text-main); flex: 1;">ì¦‰ì‹œ ê²€ì‚¬</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Section (New) -->
        <div id="section-logs" class="content-section" style="display: none;">
            <div class="monitor-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ìµœê·¼ ëª¨ë‹ˆí„°ë§ ë¡œê·¸ (ì‹¤ì‹œê°„)</h2>
                    <button class="btn-primary"
                        style="width: auto; margin-top: 0; padding: 0.5rem 1rem; font-size: 0.9rem;"
                        onclick="fetchAndDisplayLogs()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead>
                            <tr style="background: #F8FAFC; border-bottom: 2px solid #E2E8F0; text-align: left;">
                                <th style="padding: 12px; color: var(--text-sub);">ì‹œê°„</th>
                                <th style="padding: 12px; color: var(--text-sub);">ì‚¬ì´íŠ¸</th>
                                <th style="padding: 12px; color: var(--text-sub);">ìƒíƒœ</th>
                                <th style="padding: 12px; color: var(--text-sub);">ë©”ì‹œì§€</th>
                                <th style="padding: 12px; color: var(--text-sub);">ì‘ë‹µ ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr>
                                <td colspan="5" style="padding: 20px; text-align: center; color: var(--text-sub);">ë¡œë”©
                                    ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Spam History Section (v1.5) -->
        <div id="section-spam-logs" class="content-section" style="display: none;">
            <div class="monitor-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ›¡ï¸ ìŠ¤íŒ¸ ê°ì§€ ë‚´ì—­ (ìµœê·¼ 7ì¼)</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div id="adminSiteSelector" style="display: none;">
                            <select id="siteFilter" onchange="fetchAndDisplaySpamLogs()"
                                style="padding: 0.5rem; border-radius: 6px; font-size: 0.9rem;">
                                <option value="">ì „ì²´ ì‚¬ì´íŠ¸</option>
                            </select>
                        </div>
                        <button class="btn-primary"
                            style="width: auto; margin-top: 0; padding: 0.5rem 1rem; font-size: 0.9rem;"
                            onclick="fetchAndDisplaySpamLogs()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #F8FAFC; border-bottom: 2px solid #E2E8F0; text-align: left;">
                                <th style="padding: 12px; color: var(--text-sub);">íƒì§€ ì‹œê°</th>
                                <th style="padding: 12px; color: var(--text-sub);">ì‚¬ì´íŠ¸/ê²Œì‹œíŒ</th>
                                <th style="padding: 12px; color: var(--text-sub);">ì œëª© (ë§ˆìŠ¤í‚¹)</th>
                                <th style="padding: 12px; color: var(--text-sub);">ì‚¬ìœ </th>
                                <th style="padding: 12px; color: var(--text-sub);">ì ìˆ˜</th>
                                <th style="padding: 12px; color: var(--text-sub);">ìƒíƒœ</th>
                                <th id="thAction" style="padding: 12px; color: var(--text-sub);">ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="spamLogsTableBody">
                            <tr>
                                <td colspan="7" style="padding: 20px; text-align: center; color: var(--text-sub);">ë¡œë”©
                                    ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="section-settings" class="content-section" style="display: none;">
            <!-- ... settings ... -->
            <div class="monitor-card">
                <h2>ì•Œë¦¼ ì„¤ì •</h2>
                <!-- ... -->
                <button class="btn-primary" onclick="alert('ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.')" style="width: 200px;">ì €ì¥</button>
            </div>
        </div>
        <!-- (omitted other sections for brevity in replacement, but kept in replace tool logic if I could, but wait replace tool replaces chunks) -->
        <!-- Since I need to replace a large chunk, I'll stick to the dashboard section primarily. -->
        <!-- Actually, I need to be careful not to delete other sections if I select too much. -->
        <!-- I will replace just the section-dashboard content and then append the JS function. -->
        <!-- Wait, I can't append easily. I'll replace the dashboard section and the start of script maybe? No, that's messy. -->
        <!-- I will use two replace calls. One for HTML, one for JS. -->

        <!-- REVISING PLAN: I will do this in 2 calls. Call 1: HTML update. Call 2: JS addition. -->
        <!-- This tool call will ONLY update the HTML part. -->


        <!-- Settings Section -->
        <div id="section-settings" class="content-section" style="display: none;">
            <div class="monitor-card">
                <h2>ì•Œë¦¼ ì„¤ì •</h2>
                <div style="margin-top: 20px;">
                    <label
                        style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; justify-content: flex-start;">
                        <input type="checkbox" checked style="width: auto; margin: 0;"> ì¥ì•  ë°œìƒ ì‹œ ë¬¸ì ì•Œë¦¼ (010-****-1234)
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; justify-content: flex-start;">
                        <input type="checkbox" checked style="width: auto; margin: 0;"> ìŠ¤íŒ¸ ìë™ ì‚­ì œ ë‚´ì—­ ì£¼ê°„ ë¦¬í¬íŠ¸ ë°›ê¸°
                    </label>
                </div>

                <h2 style="margin-top: 30px;">ì§‘ì¤‘ ê²€ì‚¬ ì„¤ì •</h2>
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì§‘ì¤‘ ëª¨ë‹ˆí„°ë§ ê²Œì‹œíŒ (ì„ íƒ)</label>
                    <input type="text" id="specificBoardTable" placeholder="ì˜ˆ: g5_write_online (ë¹„ì›Œë‘ë©´ ì „ì²´ ìŠ¤ìº”)"
                        style="width: 100%; padding: 10px; border: 1px solid #CBD5E1; border-radius: 6px;">
                    <p style="color: var(--text-sub); font-size: 0.9rem; margin-top: 5px;">
                        * íŠ¹ì • ê²Œì‹œíŒë§Œ ì§‘ì¤‘ì ìœ¼ë¡œ ê²€ì‚¬í•˜ê³  ì‹¶ì„ ë•Œ ì…ë ¥í•˜ì„¸ìš”.<br>
                        * ë¹„ì›Œë‘ë©´ ìë™ìœ¼ë¡œ ì°¾ì€ ëª¨ë“  ê²Œì‹œíŒì„ ê²€ì‚¬í•©ë‹ˆë‹¤.
                    </p>
                </div>

                <button class="btn-primary" onclick="saveSettings()" style="width: 200px; margin-top: 20px;">ì„¤ì •
                    ì €ì¥</button>
            </div>
        </div>

        <!-- Billing Section -->
        <div id="section-billing" class="content-section" style="display: none;">
            <div class="monitor-card">
                <h2>ì´ë²ˆ ë‹¬ ê²°ì œ ì˜ˆì • ê¸ˆì•¡</h2>
                <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin: 20px 0;">19,800ì›</div>
                <p style="color: var(--text-sub); margin-bottom: 30px;">ê²°ì œì¼: 2026ë…„ 2ì›” 25ì¼</p>

                <h3>ê²°ì œ ë‚´ì—­</h3>
                <div style="margin-top: 15px; border-top: 1px solid #e2e8f0;">
                    <div
                        style="display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #e2e8f0;">
                        <span>2026.01.25 ì •ê¸°ê²°ì œ</span>
                        <span style="font-weight: 600;">19,800ì›</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #e2e8f0;">
                        <span>2025.12.25 ì •ê¸°ê²°ì œ</span>
                        <span style="font-weight: 600;">19,800ì›</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="section-profile" class="content-section" style="display: none;">
            <div class="monitor-card">
                <h2>ë‚´ ì •ë³´ ìˆ˜ì •</h2>
                <div style="margin-top: 2rem;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì´ë©”ì¼ (ë³€ê²½ ë¶ˆê°€)</label>
                        <input type="email" id="profileEmail" disabled
                            style="background: #f1f5f9; cursor: not-allowed; opacity: 0.7;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì´ë¦„</label>
                        <input type="text" id="profileName">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì „í™”ë²ˆí˜¸</label>
                        <input type="text" id="profilePhone">
                    </div>
                    <div style="margin-bottom: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ì‹œì—ë§Œ ì…ë ¥)</label>
                        <input type="password" id="profilePassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
                    </div>
                    <button class="btn-primary" onclick="updateProfile()">ì •ë³´ ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <!-- Support Section -->
        <div id="section-support" class="content-section" style="display: none;">
            <div class="monitor-card">
                <h2>1:1 ë¬¸ì˜í•˜ê¸°</h2>
                <p style="color: var(--text-sub); margin-bottom: 2rem;">ê¶ê¸ˆí•œ ì ì´ë‚˜ ê¸°ìˆ  ì§€ì›ì´ í•„ìš”í•˜ì‹œë©´ ì–¸ì œë“  ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p>
                <input type="text" placeholder="ë¬¸ì˜ ì œëª©" style="margin-bottom: 10px;">
                <textarea
                    style="width: 100%; height: 200px; padding: 15px; border-radius: 8px; border: 1px solid #CBD5E1; resize: none;"
                    placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                <button class="btn-primary" onclick="alert('ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹´ë‹¹ìê°€ ê³§ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.')">ë¬¸ì˜ ì ‘ìˆ˜í•˜ê¸°</button>
            </div>
        </div>
        <!-- Security Guide Section (New) -->
        <div id="section-security-guide" class="content-section" style="display: none;">
            <div class="monitor-card">
                <h2 style="margin-bottom: 2rem;">ğŸ›¡ï¸ Keepy ë³´ì•ˆ ì‹œìŠ¤í…œ ì•ˆë‚´</h2>

                <div style="display: grid; gap: 2rem;">
                    <div
                        style="background: #F8FAFC; padding: 1.5rem; border-radius: 12px; border-left: 5px solid var(--primary);">
                        <h3 style="color: var(--primary); margin-bottom: 0.5rem;">1ë‹¨ê³„: ì‹¤ì‹œê°„ ì—°ê²° ê°ì‹œ (Hearthbeat Check)</h3>
                        <p style="color: var(--text-sub); line-height: 1.6;">
                            ì‚¬ìš©ìì˜ í™ˆí˜ì´ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ì—´ë¦¬ëŠ”ì§€ <strong>24ì‹œê°„ ì‹¤ì‹œê°„</strong>ìœ¼ë¡œ ê°ì‹œí•©ë‹ˆë‹¤.<br>
                            ë‹¨ìˆœíˆ í˜ì´ì§€ë§Œ í™•ì¸í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì‹¤ì œë¡œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì‘ë‹µí•˜ëŠ”ì§€ê¹Œì§€ ì²´í¬í•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div
                        style="background: #F8FAFC; padding: 1.5rem; border-radius: 12px; border-left: 5px solid var(--danger);">
                        <h3 style="color: var(--danger); margin-bottom: 0.5rem;">2ë‹¨ê³„: ìŠ¤íŒ¸ í—Œí„° (Spam Hunter)</h3>
                        <p style="color: var(--text-sub); line-height: 1.6;">
                            ê²Œì‹œíŒì— ë“±ë¡ë˜ëŠ” <strong>ì•…ì„± ìŠ¤íŒ¸(ì¹´ì§€ë…¸, ë„ë°• ë“±)</strong>ì„ ìë™ìœ¼ë¡œ íƒì§€í•˜ê³  ì¦‰ì‹œ ì‚­ì œí•©ë‹ˆë‹¤.<br>
                            íŠ¹ì • í‚¤ì›Œë“œë¿ë§Œ ì•„ë‹ˆë¼ ë¬´ì‘ìœ„ ë¬¸ìì—´(ì™¸ê³„ì–´)ê¹Œì§€ ë¶„ì„í•˜ì—¬ ì°¨ë‹¨í•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div
                        style="background: #F8FAFC; padding: 1.5rem; border-radius: 12px; border-left: 5px solid var(--success);">
                        <h3 style="color: var(--success); margin-bottom: 0.5rem;">3ë‹¨ê³„: ì…€í”„ íë§ (Self Healing)</h3>
                        <p style="color: var(--text-sub); line-height: 1.6;">
                            ì„œë²„ ì¥ì• ë‚˜ DB ì—°ê²° ëŠê¹€ì´ ê°ì§€ë˜ë©´, ê´€ë¦¬ìê°€ ê°œì…í•˜ê¸° ì „ì— <strong>ìë™ìœ¼ë¡œ ë³µêµ¬</strong>ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.<br>
                            (í˜„ì¬ ë‹¨ê³„ì—ì„œëŠ” ì—°ê²° ì¬ì‹œë„ ë° ìë™ ì•Œë¦¼ ë°œì†¡ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.)
                        </p>
                    </div>
                </div>
            </div>


        </div>
        </div>
    </main>

    <script>
        // Check authentication on page load
        const token = localStorage.getItem('keepy_token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // Check if user is admin and show admin menu
        const user = JSON.parse(localStorage.getItem('keepy_user') || '{}');
        if (user.role === 'admin') {
            document.getElementById('adminMenuItem').style.display = 'block';
        }

        // Initialize User Info
        document.getElementById('userNameLabel').innerText = `${user.name} ë‹˜`;
        document.getElementById('userRoleBadge').innerText = user.role === 'admin' ? 'Admin' : 'User';
        document.getElementById('profileEmail').value = user.email || '';
        document.getElementById('profileName').value = user.name || '';
        document.getElementById('profilePhone').value = user.phone || '';

        // Helper function to make authenticated requests
        async function authFetch(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };

            try {
                const response = await fetch(url, { ...options, headers });

                // v1.5: Unified 401 Interceptor for Auto-Logout
                if (response.status === 401) {
                    alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    logout();
                    return null;
                }

                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        async function updateProfile() {
            const name = document.getElementById('profileName').value;
            const phone = document.getElementById('profilePhone').value;
            const password = document.getElementById('profilePassword').value;

            const response = await authFetch('/auth/profile', {
                method: 'PATCH',
                body: JSON.stringify({ name, phone, password: password || undefined })
            });

            if (!response) return;

            const data = await response.json();
            alert('ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');

            // Update local storage and UI
            const updatedUser = { ...user, name: data.user.name, phone: data.user.phone };
            localStorage.setItem('keepy_user', JSON.stringify(updatedUser));
            document.getElementById('userNameLabel').innerText = `${updatedUser.name} ë‹˜`;
            document.getElementById('profilePassword').value = '';
        }

        function logout() {
            localStorage.removeItem('keepy_token');
            localStorage.removeItem('keepy_user');
            window.location.href = '/login.html';
        }

        const priceMap = {
            1: '29,800ì›',
            3: '19,800ì›',
            5: '9,900ì›'
        };

        function updatePrice() {
            const interval = document.getElementById('intervalSelect').value;
            document.getElementById('priceDisplay').innerText = priceMap[interval];
        }

        async function saveMonitoringInterval() {
            if (!window.currentSiteId) {
                alert('ë“±ë¡ëœ ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const interval = parseInt(document.getElementById('intervalSelect').value);

            try {
                const response = await authFetch(`/sites/${window.currentSiteId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ monitoring_interval: interval })
                });

                if (response && response.ok) {
                    alert(`ëª¨ë‹ˆí„°ë§ ì£¼ê¸°ê°€ ${interval}ë¶„ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    // Refresh dashboard to show updated settings
                    fetchDashboardData();
                } else {
                    alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Save interval failed:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function saveSettings() {
            if (!window.currentSiteId) {
                alert('ë“±ë¡ëœ ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const specificBoard = document.getElementById('specificBoardTable').value;

            try {
                const response = await authFetch(`/sites/${window.currentSiteId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        specific_board_table: specificBoard
                    })
                });

                if (response && response.ok) {
                    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n[ì§‘ì¤‘ ê²€ì‚¬ ê²Œì‹œíŒ]ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¦‰ì‹œ ê²€ì‚¬ë¥¼ ì‹¤í–‰í•˜ë©´ í•´ë‹¹ ê²Œì‹œíŒì„ ìš°ì„  ê²€ì‚¬í•©ë‹ˆë‹¤.');
                } else {
                    alert('ì„¤ì • ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Save failed:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function fetchDashboardData() {
            try {
                // 1. Fetch Sites (with auth)
                const sitesRes = await authFetch('/sites');
                if (!sitesRes) return;

                const sites = await sitesRes.json();

                if (sites.length > 0) {
                    // Hide register, show status
                    document.getElementById('registerCard').style.display = 'none';
                    document.getElementById('statusCard').style.display = 'block';

                    const site = sites[0]; // Primary site
                    window.currentSiteId = site.id; // Store for updates

                    // Set monitoring interval dropdown to match database value
                    const intervalSelect = document.getElementById('intervalSelect');
                    if (intervalSelect && site.monitoring_interval) {
                        intervalSelect.value = site.monitoring_interval;
                        updatePrice(); // Update price display to match
                    }

                    // Set specific board input if exists
                    if (site.specific_board_table) {
                        const boardInput = document.getElementById('specificBoardTable');
                        if (boardInput) boardInput.value = site.specific_board_table;
                    }

                    // Update Status
                    const statusText = site.current_status === 'healthy' ? 'ì •ìƒ ì‘ë™ ì¤‘' : 'ì¥ì•  ë°œìƒ í™•ì¸';
                    const statusColor = site.current_status === 'healthy' ? 'var(--success)' : 'var(--danger)';
                    const statusDot = document.querySelector('.status-dot');
                    const statusMsg = document.querySelector('.site-status span');

                    if (statusDot) {
                        statusDot.style.background = statusColor;
                        statusDot.style.boxShadow = `0 0 10px ${statusColor}`;
                    }
                    if (statusMsg) {
                        statusMsg.innerText = `${site.site_name} ${statusText}`;
                        statusMsg.style.color = statusColor;
                    }

                    // Update Last Checked
                    const lastChecked = document.getElementById('lastChecked');
                    if (lastChecked) {
                        lastChecked.innerHTML = `ìµœê·¼ ì ê²€: ${new Date().toLocaleTimeString()} (<a href="${site.target_url}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">${site.target_url} ğŸ”—</a>)`;
                    }
                } else {
                    // No sites: Show register card, hide status
                    document.getElementById('registerCard').style.display = 'block';
                    document.getElementById('statusCard').style.display = 'none';
                }

                // 2. Fetch Logs (with auth)
                const logsRes = await authFetch('/monitoring/logs');
                if (!logsRes) return;

                const logs = await logsRes.json();

                // Update Uptime (Mock calculation based on logs for now)
                const errorCount = logs.filter(l => l.status === 'error').length;
                const uptime = errorCount === 0 ? '100%' : '99.9%';
                document.getElementById('uptimeValue').innerText = uptime;

            } catch (error) {
                console.error('Failed to fetch dashboard data:', error);
            }
        }

        async function fetchAndDisplayLogs() {
            try {
                const response = await authFetch('/monitoring/logs');
                if (!response) return;

                const logs = await response.json();
                const tbody = document.getElementById('logsTableBody');

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--text-sub);">ê¸°ë¡ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => {
                    const statusColor = log.status === 'healthy' || log.status === 'up' ? 'var(--success)' : 'var(--danger)';
                    const statusText = log.status.toUpperCase();
                    const time = new Date(log.timestamp).toLocaleString();
                    const responseTime = log.response_time ? `${log.response_time}ms` : '-';

                    return `
                        <tr style="border-bottom: 1px solid #E2E8F0;">
                            <td style="padding: 12px;">${time}</td>
                            <td style="padding: 12px; font-weight: 600;">${log.site_name || 'Site'}</td>
                            <td style="padding: 12px;"><span style="color: ${statusColor}; font-weight: 600;">${statusText}</span></td>
                            <td style="padding: 12px;">${log.message || '-'}</td>
                            <td style="padding: 12px;">${responseTime}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to fetch logs:', error);
                document.getElementById('logsTableBody').innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--danger);">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        async function registerMinHospital() {
            const resultEl = document.getElementById('registerResult');
            resultEl.innerHTML = '<div style="color: var(--primary);">ë“±ë¡ ì¤‘...</div>';

            try {
                const response = await authFetch('/sites/register-db', {
                    method: 'POST',
                    body: JSON.stringify({
                        host: 'localhost',
                        user: 'minhospital2008',
                        pass: 'minho3114*',
                        name: 'minhospital2008',
                        domain: 'minhospital.co.kr'
                    })
                });

                if (!response) return;
                const result = await response.json();

                if (response.ok) {
                    resultEl.innerHTML = `<div style="color: var(--success); font-weight: 600;">âœ… ${result.message}<br>ìƒíƒœ: ${result.current_status}</div>`;
                    // Refresh dash
                    setTimeout(fetchDashboardData, 1000);
                } else {
                    resultEl.innerHTML = `<div style="color: var(--danger);">âŒ ${result.error}</div>`;
                }
            } catch (error) {
                resultEl.innerHTML = `<div style="color: var(--danger);">âŒ ë“±ë¡ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        // Initial Load & Polling
        fetchDashboardData();

        // v1.5: Role-based Initialization
        if (user.role === 'admin') {
            document.getElementById('adminSiteSelector').style.display = 'block';
            fetchAdminSites();
        }

        async function fetchAdminSites() {
            const res = await authFetch('/sites');
            if (res && res.ok) {
                const sites = await res.json();
                const select = document.getElementById('siteFilter');
                if (!select) return;
                sites.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.site_name;
                    select.appendChild(opt);
                });
            }
        }

        setInterval(() => {
            fetchDashboardData();
            // Auto-refresh logs if tab is active
            if (document.getElementById('section-logs').style.display !== 'none') {
                fetchAndDisplayLogs();
            } else if (document.getElementById('section-spam-logs').style.display !== 'none') {
                fetchAndDisplaySpamLogs();
            }
        }, 5000); // Poll every 5 seconds (Avoid too frequent request)

        async function fetchAndDisplaySpamLogs() {
            try {
                const siteId = document.getElementById('siteFilter').value;
                const url = `/api/spam-logs?days=7${siteId ? `&site_id=${siteId}` : ''}`;
                const response = await authFetch(url);
                if (!response) return;

                const data = await response.json();
                const tbody = document.getElementById('spamLogsTableBody');
                const isAdmin = user.role === 'admin';

                if (data.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--text-sub);">ìµœê·¼ 7ì¼ê°„ íƒì§€ëœ ìŠ¤íŒ¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.items.map(log => {
                    const statusColors = {
                        'detected': '#F59E0B',
                        'deleted': '#10B981',
                        'delete_failed': '#EF4444'
                    };
                    const date = new Date(log.detected_at).toLocaleString();
                    const statusText = log.status === 'detected' ? 'íƒì§€ë¨' : (log.status === 'deleted' ? 'ì‚­ì œë¨' : 'ì‚­ì œì‹¤íŒ¨');

                    const isAdmin = user.role === 'admin';
                    const canDelete = isAdmin || log.can_user_delete_spam;

                    return `
                        <tr style="border-bottom: 1px solid #E2E8F0;">
                            <td style="padding: 12px; font-size: 0.8rem;">${date}</td>
                            <td style="padding: 12px;">
                                <div style="font-weight: 600;">${log.site_name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-sub);">${log.target_board_table}</div>
                            </td>
                            <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${log.subject}
                            </td>
                            <td style="padding: 12px; font-size: 0.75rem;">${(log.reasons || []).join(', ')}</td>
                            <td style="padding: 12px; font-weight: 600;">${log.score}</td>
                            <td style="padding: 12px;">
                                <span style="padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; background: ${statusColors[log.status]}22; color: ${statusColors[log.status]}; font-weight: 600;">
                                    ${statusText}
                                </span>
                            </td>
                            <td style="padding: 12px;">
                                ${log.status !== 'deleted' ? (
                            canDelete ?
                                `<button onclick="deleteSpamPost('${log.log_id}')" style="padding: 4px 8px; font-size: 0.75rem; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">ì‚­ì œ</button>` :
                                `<button disabled title="ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤" style="padding: 4px 8px; font-size: 0.75rem; background: #CBD5E1; color: white; border: none; border-radius: 4px; cursor: not-allowed; opacity: 0.7;">ì‚­ì œ ì œí•œ</button>`
                        ) : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to fetch spam logs:', error);
            }
        }

        async function deleteSpamPost(logId) {
            if (!confirm('í•´ë‹¹ ê²Œì‹œë¬¼ì„ ì‹¤ì œ í™ˆí˜ì´ì§€ì—ì„œ ì‚­ì œí•©ë‹ˆë‹¤. ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const res = await authFetch(`/api/spam-logs/${logId}/delete`, { method: 'POST' });
            if (!res) return;

            if (res.ok) {
                alert('ê²Œì‹œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchAndDisplaySpamLogs();
            } else {
                const data = await res.json();
                if (res.status === 409) {
                    alert('ì´ë¯¸ ì‚­ì œëœ ê²Œì‹œë¬¼ì…ë‹ˆë‹¤.');
                } else if (res.status === 403) {
                    alert('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤ (NO_DELETE_PERMISSION).\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                } else {
                    alert(`ì‚­ì œ ì‹¤íŒ¨: ${data.error}`);
                }
                fetchAndDisplaySpamLogs();
            }
        }

        function switchTab(tabId, element) {
            // Update Title
            const titles = {
                'dashboard': 'ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ',
                'logs': 'ëª¨ë‹ˆí„°ë§ ë¡œê·¸ ê¸°ë¡',
                'spam-logs': 'ìŠ¤íŒ¸ ê°ì§€ ë‚´ì—­ (ìµœê·¼ 7ì¼)',
                'settings': 'ëª¨ë‹ˆí„°ë§ ì„¤ì •',
                'billing': 'ê²°ì œ ë‚´ì—­',
                'profile': 'ë‚´ ì •ë³´ ìˆ˜ì •',
                'support': 'ê³ ê°ì„¼í„°',
                'security-guide': 'ë³´ì•ˆ ê¸°ëŠ¥ ì•ˆë‚´'
            };
            document.getElementById('pageTitle').innerText = titles[tabId];

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');

            // Show selected section
            document.getElementById('section-' + tabId).style.display = 'block';

            // Update Menu Active State
            document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));
            element.classList.add('active');

            // Load specific data if needed
            if (tabId === 'logs') {
                fetchAndDisplayLogs();
            } else if (tabId === 'spam-logs') {
                fetchAndDisplaySpamLogs();
            }
        }
    </script>
</body>

</html>