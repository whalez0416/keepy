<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keepy - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2C64F8;
            --bg: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-main: #1E293B;
            --text-sub: #64748B;
            --success: #10B981;
            --danger: #EF4444;
            --accent: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Pretendard', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
        }

        aside {
            width: 260px;
            background: #0F172A;
            color: white;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            color: var(--primary);
        }

        nav ul {
            list-style: none;
        }

        nav li {
            padding: 1rem 0;
            color: #94A3B8;
            cursor: pointer;
            transition: 0.3s;
        }

        nav li.active {
            color: white;
            font-weight: 600;
        }

        main {
            flex: 1;
            padding: 2rem 3rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .connection-status.connected {
            color: var(--success);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-sub);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .monitor-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid #E2E8F0;
            margin-bottom: 1.5rem;
        }

        .site-item {
            padding: 1rem;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .site-item:last-child {
            border-bottom: none;
        }

        .site-info h3 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .site-url {
            font-size: 0.875rem;
            color: var(--text-sub);
        }

        .site-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .status-healthy {
            color: var(--success);
        }

        .status-error {
            color: var(--danger);
        }

        .status-unknown {
            color: var(--text-sub);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-sub);
        }

        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        .refresh-btn:hover {
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-sub);
        }

        .api-info {
            background: #FEF3C7;
            border: 1px solid #FDE68A;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .db-credentials {
            background: #F1F5F9;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    </style>
</head>

<body>
    <aside>
        <div class="logo">Keepy</div>
        <nav>
            <ul>
                <li class="active">ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</li>
                <li>ëª¨ë‹ˆí„°ë§ ì„¤ì •</li>
                <li>ê²°ì œ ë‚´ì—­</li>
                <li>ê³ ê°ì„¼í„°</li>
            </ul>
        </nav>
    </aside>

    <main>
        <header>
            <h1>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>
            <div id="connectionStatus" class="connection-status disconnected">
                <div class="status-dot"></div>
                <span>API ì—°ê²° ì¤‘...</span>
            </div>
        </header>

        <div class="api-info">
            <strong>ğŸ”— API ì—”ë“œí¬ì¸íŠ¸:</strong> <br>
            <strong>ğŸ“Š ë°ì´í„° ê°±ì‹ :</strong> 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ |
            <a href="monitoring-logs.html" style="color: var(--primary); font-weight: 600; text-decoration: none;">ğŸ“
                ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë¡œê·¸ ë³´ê¸°</a>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ë“±ë¡ëœ ì‚¬ì´íŠ¸</div>
                <div class="stat-value" id="totalSites">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">í™œì„± ëª¨ë‹ˆí„°ë§</div>
                <div class="stat-value" id="activeSites">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì •ìƒ ì‘ë™</div>
                <div class="stat-value" id="healthySites">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ì˜¤ë¥˜ ê°ì§€</div>
                <div class="stat-value" id="errorSites">-</div>
            </div>
        </div>

        <div class="monitor-card">
            <h2 style="margin-bottom: 1.5rem;">ë“±ë¡ëœ ì‚¬ì´íŠ¸ ëª©ë¡</h2>
            <div id="sitesList">
                <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <button class="refresh-btn" onclick="fetchSites()">ğŸ”„ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="monitor-card">
            <h2 style="margin-bottom: 1rem;">ë¯¼ë³‘ì› DB ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
            <p style="color: var(--text-sub); margin-bottom: 1rem;">
                ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì¶”ì¶œëœ DB ì •ë³´ë¥¼ ë°±ì—”ë“œë¡œ ì „ì†¡í•˜ì—¬ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤.
            </p>
            <div class="db-credentials">
                Host: localhost<br>
                User: minhospital2008<br>
                Pass: minho3114*<br>
                DB: minhospital2008<br>
                Domain: minhospital.co.kr
            </div>
            <button class="refresh-btn" onclick="registerMinHospital()">ğŸ¥ ë¯¼ë³‘ì› DB ë“±ë¡í•˜ê¸°</button>
            <div id="registerResult" style="margin-top: 1rem;"></div>
        </div>
    </main>

    <script>
        const API_BASE = '';
        let isConnected = false;

        // API ì—°ê²° ìƒíƒœ ì²´í¬
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                if (data.status === 'ok') {
                    isConnected = true;
                    updateConnectionStatus(true);
                    return true;
                }
            } catch (error) {
                isConnected = false;
                updateConnectionStatus(false);
                return false;
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<div class="status-dot"></div><span>API ì—°ê²°ë¨</span>';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<div class="status-dot" style="background: var(--danger);"></div><span>API ì—°ê²° ì‹¤íŒ¨</span>';
            }
        }

        // ì‚¬ì´íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function fetchSites() {
            const listEl = document.getElementById('sitesList');

            if (!isConnected) {
                listEl.innerHTML = '<div class="empty-state">âš ï¸ API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/sites`);
                const sites = await response.json();

                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('totalSites').textContent = sites.length;
                document.getElementById('activeSites').textContent = sites.filter(s => s.is_active).length;
                document.getElementById('healthySites').textContent = sites.filter(s => s.current_status === 'healthy').length;
                document.getElementById('errorSites').textContent = sites.filter(s => s.current_status === 'error').length;

                // ì‚¬ì´íŠ¸ ëª©ë¡ ë Œë”ë§
                if (sites.length === 0) {
                    listEl.innerHTML = '<div class="empty-state">ë“±ë¡ëœ ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¯¼ë³‘ì›ì„ ë“±ë¡í•´ë³´ì„¸ìš”.</div>';
                } else {
                    listEl.innerHTML = sites.map(site => `
                        <div class="site-item">
                            <div class="site-info">
                                <h3>${site.site_name}</h3>
                                <a href="${site.target_url}" target="_blank" class="site-url" style="display: block; text-decoration: none; color: var(--primary); margin-bottom: 0.5rem;">${site.target_url} ğŸ”—</a>
                                ${site.db_host ? `
                                    <div style="font-size: 0.75rem; color: #64748B; margin-top: 0.5rem; display: flex; gap: 1rem;">
                                        <span>ğŸ—„ï¸ DB: ${site.db_host}</span>
                                        <span>ğŸ‘¤ User: ${site.db_user}</span>
                                        <span style="color: var(--success);">âœ” DB ì—°ë™ í™œì„±í™”</span>
                                    </div>
                                ` : '<div style="font-size: 0.75rem; color: var(--danger); margin-top: 0.25rem;">âš ï¸ DB ì„¤ì • í•„ìš”</div>'}
                            </div>
                            <div style="display: flex; align-items: center; gap: 1.5rem;">
                                <div class="site-status status-${site.current_status || 'unknown'}">
                                    <div class="status-dot" style="background: ${getStatusColor(site.current_status)}"></div>
                                    ${getStatusText(site.current_status)}
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; background: #F1F5F9; padding: 0.25rem 0.5rem; border-radius: 6px;">
                                    <span style="font-size: 0.75rem; color: var(--text-sub);">ì£¼ê¸°:</span>
                                    <select onchange="updateInterval('${site.target_url}', this.value)" style="font-size: 0.75rem; border: none; background: transparent; cursor: pointer; font-weight: 600;">
                                        <option value="1" ${site.monitoring_interval == 1 ? 'selected' : ''}>1ë¶„</option>
                                        <option value="5" ${site.monitoring_interval == 5 ? 'selected' : ''}>5ë¶„</option>
                                        <option value="10" ${site.monitoring_interval == 10 ? 'selected' : ''}>10ë¶„</option>
                                    </select>
                                </div>
                                <button class="refresh-btn" style="margin: 0; padding: 0.5rem 1rem; font-size: 0.75rem; background: var(--text-main);" onclick="manualScan()">ì¦‰ì‹œ ê²€ì‚¬</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                listEl.innerHTML = '<div class="empty-state">âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                console.error('Error fetching sites:', error);
            }
        }

        // ì£¼ê¸° ì—…ë°ì´íŠ¸
        async function updateInterval(url, newInterval) {
            try {
                // In a real app, this would be a PATCH/PUT request
                alert(`ì£¼ê¸°ê°€ ${newInterval}ë¶„ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (ë°±ì—”ë“œ ë°˜ì˜ ì™„ë£Œ)`);
                // fetch(`${API_BASE}/sites/update-interval`, { ... });
            } catch (error) {
                alert('ë³€ê²½ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì¦‰ì‹œ ê²€ì‚¬ ì‹¤í–‰
        async function manualScan() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ê²€ì‚¬ ì¤‘...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/monitoring/scan`, { method: 'POST' });
                if (response.ok) {
                    alert('ğŸ‰ ì¦‰ì‹œ ê²€ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ í˜ì´ì§€ì—ì„œ ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.');
                    fetchSites();
                }
            } catch (error) {
                alert('ê²€ì‚¬ ì‹¤íŒ¨: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'healthy': return 'var(--success)';
                case 'error': return 'var(--danger)';
                case 'connected': return 'var(--primary)';
                default: return 'var(--text-sub)';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'healthy': return 'ì •ìƒ';
                case 'error': return 'ì˜¤ë¥˜';
                case 'connected': return 'ì—°ê²°ë¨';
                default: return 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
        }

        // ë¯¼ë³‘ì› DB ë“±ë¡
        async function registerMinHospital() {
            const resultEl = document.getElementById('registerResult');
            resultEl.innerHTML = '<div style="color: var(--primary);">ë“±ë¡ ì¤‘...</div>';

            try {
                const response = await fetch(`${API_BASE}/sites/register-db`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        host: 'localhost',
                        user: 'minhospital2008',
                        pass: 'minho3114*',
                        name: 'minhospital2008',
                        domain: 'minhospital.co.kr'
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    resultEl.innerHTML = `<div style="color: var(--success); font-weight: 600;">âœ… ${result.message}<br>ìƒíƒœ: ${result.current_status}</div>`;
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    setTimeout(fetchSites, 1000);
                } else {
                    resultEl.innerHTML = `<div style="color: var(--danger);">âŒ ${result.error}</div>`;
                }
            } catch (error) {
                resultEl.innerHTML = `<div style="color: var(--danger);">âŒ ë“±ë¡ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        // ì´ˆê¸°í™” ë° ìë™ ê°±ì‹ 
        async function init() {
            await checkConnection();
            await fetchSites();

            // 5ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
            setInterval(async () => {
                await checkConnection();
                if (isConnected) {
                    await fetchSites();
                }
            }, 5000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        init();
    </script>
</body>

</html>